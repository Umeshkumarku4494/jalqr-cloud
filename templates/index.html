<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JALQR - Smart Water Scanner</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; }
        #video-wrapper {
            position: relative;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }
        video {
            width: 100%;
            display: block;
        }
        .results-card {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: left;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            background: #eee;
        }
        .chem-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .chem-item {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ’§ JALQR Scanner</h1>
    <p>Point your camera at the test strip QR code</p>

    <div id="video-wrapper">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <div class="results-card">
        <div>Status: <span id="status" class="status-badge">WAITING</span></div>
        <div class="chem-list">
            <div class="chem-item">Chlorine: <b id="cl">-</b></div>
            <div class="chem-item">Nitrate: <b id="no3">-</b></div>
            <div class="chem-item">Iron: <b id="fe">-</b></div>
            <div class="chem-item">Phosphate: <b id="po4">-</b></div>
        </div>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    // UI Elements
    const statusEl = document.getElementById('status');
    const clEl = document.getElementById('cl');
    const no3El = document.getElementById('no3');
    const feEl = document.getElementById('fe');
    const po4El = document.getElementById('po4');

    // 1. Request Camera Access
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } // Forces back camera on mobile
            });
            video.srcObject = stream;
        } catch (err) {
            console.error("Camera Error: ", err);
            alert("Please allow camera access and ensure you are on HTTPS.");
            statusEl.innerText = "CAMERA ERROR";
        }
    }

    // 2. Capture and Send Frame
    function scanFrame() {
        if (video.videoWidth === 0) return;

        // Set canvas size to video size
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw current video frame to canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert to Base64
        const base64Image = canvas.toDataURL('image/jpeg', 0.7);

        // POST to Flask /analyze route
        fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64Image })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                statusEl.innerText = data.status;
                clEl.innerText = data.chlorine || '0';
                no3El.innerText = data.nitrate || '0';
                feEl.innerText = data.iron || '0';
                po4El.innerText = data.phosphate || '0';
                
                // Change status color based on success
                statusEl.style.backgroundColor = data.status === "SUCCESS" ? "#d4edda" : "#f8d7da";
            }
        })
        .catch(err => console.error("Analysis Error:", err));
    }

    // Start everything
    initCamera();
    // Scan every 1.5 seconds to avoid overloading the server
    setInterval(scanFrame, 1500);
</script>

</body>
</html>
