<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JalQR â€“ Smart Water Scanner</title>
    <style>
        :root {
            --primary-blue: #0072ff;
            --bg-gradient: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f4f8;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            background: var(--bg-gradient);
            width: 100%;
            padding: 40px 20px;
            color: white;
            text-align: center;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 2.5rem; letter-spacing: 1px; }
        .tagline { font-size: 1.2rem; font-weight: 600; margin: 10px 0; opacity: 0.9; }
        .description { font-size: 0.95rem; max-width: 320px; margin: 0 auto; line-height: 1.4; opacity: 0.8; }

        .main-container {
            width: 90%;
            max-width: 500px;
            margin-top: -30px; /* Overlap with header */
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        #video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            border: 4px solid white;
        }

        video { width: 100%; height: 100%; object-fit: cover; }

        .results-header {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: #e0e0e0;
        }

        .chem-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .chem-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #edf2f7;
        }

        .chem-label { font-size: 0.75rem; color: #718096; text-transform: uppercase; display: block; }
        .chem-value { font-size: 1rem; font-weight: bold; color: #2d3748; }

        .footer-cta {
            text-align: center;
            font-weight: 700;
            color: #4a5568;
            margin: 20px 0;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

<header>
    <h1>JalQR</h1>
    <div class="tagline">Scan. Detect. Drink Safe. ðŸ’§</div>
    <p class="description">JalQR analyzes key water parameters and instantly tells you if your water is safe.</p>
</header>

<div class="main-container">
    <div class="card">
        <div id="video-container">
            <video id="webcam" autoplay playsinline></video>
        </div>
    </div>

    <div class="card">
        <div class="results-header">
            <span>DETECTION REPORT</span>
            <span id="status-badge">WAITING...</span>
        </div>
        <div class="chem-grid">
            <div class="chem-item"><span class="chem-label">Chlorine</span><span class="chem-value" id="cl">-</span></div>
            <div class="chem-item"><span class="chem-label">Nitrate</span><span class="chem-value" id="no3">-</span></div>
            <div class="chem-item"><span class="chem-label">Iron</span><span class="chem-value" id="fe">-</span></div>
            <div class="chem-item"><span class="chem-label">Phosphate</span><span class="chem-value" id="po4">-</span></div>
        </div>
    </div>

    <div class="footer-cta">
        Know Your Water Before You Drink It! ðŸ’§
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const statusBadge = document.getElementById('status-badge');

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("Camera error: Please ensure you are using HTTPS and have granted permissions.");
        }
    }

    function captureAndAnalyze() {
        if (video.videoWidth === 0) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvas.toDataURL('image/jpeg', 0.7);

        fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageData })
        })
        .then(res => res.json())
        .then(data => {
            statusBadge.innerText = data.status || "CHECK";
            document.getElementById('cl').innerText = data.chlorine || "NA";
            document.getElementById('no3').innerText = data.nitrate || "NA";
            document.getElementById('fe').innerText = data.iron || "NA";
            document.getElementById('po4').innerText = data.phosphate || "NA";

            // Color code the status
            if(data.status === "SAFE") statusBadge.style.background = "#48bb78";
            else if(data.status === "UNSAFE") statusBadge.style.background = "#f56565";
            else if(data.status === "CAUTION") statusBadge.style.background = "#ed8936";
            else statusBadge.style.background = "#e0e0e0";
            if(data.status) statusBadge.style.color = "white";
        })
        .catch(e => console.error(e));
    }

    initCamera();
    setInterval(captureAndAnalyze, 1500);
</script>

</body>
</html>
